# CLAUDE.md

Этот файл содержит руководство для Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Обзор проекта

**Spark_by_Manus** - это модернизированная система ИИ-агентов с мультимодальными возможностями, включающая:
- **Архитектура агентов**: BaseAgent с поддержкой внедрения зависимостей, специализированные агенты (Manus, Browser, Data Analysis, Presentation и др.)
- **Система инструментов**: Модульные инструменты для файловых операций, веб-браузинга, выполнения Python, поиска, интеграции MCP и генерации презентаций
- **Система презентаций**: Полный пайплайн генерации презентаций с многоязычной поддержкой, интеграцией изображений и экспортом в PDF
- **Внедрение зависимостей**: Современная DI архитектура с интерфейсами, адаптерами и фабриками для лучшей тестируемости
- **Интеграция MCP**: Поддержка Model Context Protocol для интеграции внешних инструментов
- **Поддержка Multi-LLM**: Интеграции с OpenAI, Azure, Google, Ollama и OpenRouter

## Основные команды разработки

### Тестирование
```bash
# Запуск всех тестов с отчетом покрытия
pytest --cov=app --cov-report=html:htmlcov --cov-report=term-missing --cov-report=xml

# Запуск тестов системы презентаций (100% покрытие)
python test_summary.py

# Запуск специфических категорий тестов
pytest -m unit          # Юнит-тесты
pytest -m integration   # Интеграционные тесты
pytest -m performance   # Тесты производительности
pytest -m di           # Тесты внедрения зависимостей
```

### Разработка
```bash
# Запуск основного агента Manus
python main.py --prompt "Ваша задача здесь"

# Запуск демо генерации презентаций
python main_presentation.py

# Запуск с внедрением зависимостей
python run_di_demo.py

# Запуск MCP сервера
python run_mcp_server.py

# Запуск выполнения потоков
python run_flow.py
```

### Конфигурация
- Основная конфигурация: `config/config.toml`
- LLM модели: Настраиваются в секции `[llm]` с model, base_url, api_key
- MCP серверы: Конфигурируются в `config/mcp.example.json`
- Переменные окружения: OPENAI_API_KEY, LOG_LEVEL, WORKSPACE_ROOT

## Обзор архитектуры

### Основные компоненты

**Слой агентов** (`app/agent/`):
- `base.py` - BaseAgent с поддержкой DI, управление состоянием, память, пошаговое выполнение
- `manus.py` - Основной универсальный агент с поддержкой MCP и браузерным контекстом
- `presentation_agent.py` - Специализированный агент для генерации презентаций
- `toolcall.py` - Базовый класс агента вызова инструментов
- `browser.py`, `swe.py`, `react.py` - Специализированные типы агентов

**Слой инструментов** (`app/tool/`):
- `base.py` - Интерфейс BaseTool с ToolResult
- `presentation_tools.py` - Полный пайплайн презентаций (структура, контент, изображения, экспорт)
- `browser_use_tool.py` - Автоматизация браузера с использованием playwright
- `python_execute.py` - Безопасное выполнение Python кода
- `search/` - Множественные поисковые системы (Google, Bing, Baidu, DuckDuckGo)
- `mcp.py` - MCP клиентские инструменты для внешней интеграции

**Инфраструктура** (`app/`):
- `container.py` - Контейнер внедрения зависимостей с использованием dependency-injector
- `interfaces/` - Определения протоколов для LLM, логгера, конфигурации, песочницы
- `adapters/` - Конкретные реализации, обертывающие существующие сервисы
- `factories/` - Создание объектов с DI (AgentFactory, FlowFactory)

### Паттерн внедрения зависимостей

Система поддерживает как устаревший прямой способ создания экземпляров, так и современный DI:

```python
# Устаревший способ (всё ещё работает)
agent = Manus(name="test")

# DI способ (рекомендуется для нового кода)
container = Container.create_configured_container()
container.wire_modules()
agent_factory = container.agent_factory()
agent = agent_factory.create_agent("manus", "test")
```

### Поток выполнения агента

1. **Инициализация**: Загрузка конфигурации, инициализация LLM, создание инструментов
2. **Цикл выполнения**: Пользовательский ввод → Обновление памяти → Размышление (рассуждение LLM) → Вызовы инструментов → Результаты
3. **Управление состоянием**: IDLE → RUNNING → FINISHED с обработкой ошибок
4. **Память**: Постоянная история разговора с сообщениями на основе ролей

## Ключевые файлы и расположения

### Конфигурационные файлы
- `config/config.toml` - Основная конфигурация с настройками LLM, браузера, поиска, песочницы
- `pytest.ini` - Конфигурация тестов с требованиями покрытия (минимум 90%)
- `requirements.txt` - Python зависимости с версиями

### Критически важные файлы реализации
- `app/agent/base.py:18-275` - Основная архитектура агента
- `app/agent/manus.py:18-166` - Реализация основного агента
- `app/container.py:14-130` - Настройка DI контейнера
- `app/tool/presentation_tools.py` - Полная система презентаций

### Точки входа
- `main.py` - Базовое выполнение агента Manus
- `main_presentation.py` - Генерация презентаций
- `run_di_demo.py` - Пример внедрения зависимостей
- `run_mcp_server.py` - Запуск MCP сервера

## Архитектура системы презентаций

Система презентаций представляет собой полный пайплайн с 4 основными инструментами, управляемыми PresentationAgent:

1. **GenerateStructureTool** - Создает план презентации с определением языка
2. **GenerateSlideContentTool** - Генерирует богатый контент (абзацы, маркеры, код, цитаты)
3. **SearchImageTool** - Находит изображения через Unsplash/Tavily с умным выбором источника
4. **ExportPresentationTool** - Экспортирует в форматы Markdown, HTML, JSON, PDF

**Языковая поддержка**: Автоматически определяет русский (кириллица) против английского, генерирует культурно подходящий контент

**API интеграции**: OpenAI/OpenRouter для контента, Unsplash для профессиональных изображений, Tavily для общих изображений

## Стратегия тестирования

- **Цель 100% покрытия**: Все компоненты имеют комплексные тесты
- **Категории тестов**: unit, integration, performance, di (внедрение зависимостей)
- **Тесты презентаций**: 28 тестов по 5 компонентам (структура, контент, изображения, экспорт, агент)
- **Моки**: Использует внедрение зависимостей для изолированного юнит-тестирования

## Руководство по разработке

### Разработка агентов
- Расширяйте `BaseAgent` для новых типов агентов
- Реализуйте метод `step()` для логики агента
- Используйте `update_memory()` для управления разговором
- Поддерживайте как устаревшие, так и DI паттерны инициализации

### Разработка инструментов
- Расширяйте `BaseTool` с методом `execute()`
- Возвращайте `ToolResult` с полями output/error/system
- Добавляйте в `ToolCollection` для использования агентом
- Включайте комплексную обработку ошибок

### Конфигурация
- Используйте TOML формат для основной конфигурации
- Поддерживайте переопределение переменными окружения
- Валидируйте конфигурацию в адаптерах
- Документируйте все параметры конфигурации

### Лучшие практики
- Используйте внедрение зависимостей для новых компонентов
- Поддерживайте обратную совместимость с существующим кодом
- Пишите комплексные тесты с моками
- Следуйте модульной архитектуре инструментов/агентов
- Используйте структурированное логирование с correlation ID